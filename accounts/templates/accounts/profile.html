{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile - YEE Store{% endblock %}

{% block content %}
<div class="container-fluid bg-light min-vh-100">
  <!-- Header Section -->
  <section class="py-4">
    <div class="container">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="{% url 'index' %}" class="text-decoration-none">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">My Profile</li>
        </ol>
      </nav>

      <!-- Navigation Tabs -->
      <div class="d-flex gap-3 mb-4">
        <span class="badge bg-primary px-3 py-2">My Profile</span>
        <a href="{% url 'order_history' %}" class="badge bg-light text-dark px-3 py-2 text-decoration-none">My Orders</a>
        <a href="{% url 'cart' %}" class="badge bg-light text-dark px-3 py-2 text-decoration-none">Cart</a>
        <a href="{% url 'checkout' %}" class="badge bg-light text-dark px-3 py-2 text-decoration-none">Checkout</a>
      </div>
    </div>
  </section>

  <!-- Main Profile Section -->
  <section class="pb-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="bg-white rounded-3 shadow-sm overflow-hidden">
            
            <!-- Profile Header -->
            <div class="text-center py-5 border-bottom">
              <h2 class="fw-bold mb-4">My Profile</h2>
              
              <!-- Avatar -->
              <div class="position-relative d-inline-block mb-3">
                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                     style="width: 120px; height: 120px;">
                  {% if user.first_name %}
                    <span class="text-white fs-1 fw-bold">{{ user.first_name|first }}{{ user.last_name|first|default:"" }}</span>
                  {% else %}
                    <span class="text-white fs-1 fw-bold">{{ user.username|first }}</span>
                  {% endif %}
                </div>
              </div>
              
              <!-- User Info -->
              <h4 class="fw-bold mb-1">
                {% if user.get_full_name %}
                  {{ user.get_full_name }}
                {% else %}
                  {{ user.username }}
                {% endif %}
              </h4>
              <p class="text-muted mb-2">{{ user.email|default:"jane.doe@example.com" }}</p>
              <div class="d-flex justify-content-center align-items-center gap-3 text-muted small">
                {% if user.address %}
                  <span><i class="bi bi-geo-alt"></i> {{ user.address }}</span>
                {% else %}
                  <span><i class="bi bi-geo-alt"></i> Non renseigné</span>
                {% endif %}
                <span><i class="bi bi-calendar"></i> Member since {{ user.date_joined|date:"F Y" }}</span>
              </div>
              
              <button class="btn btn-outline-primary mt-3" type="button" data-bs-toggle="modal" data-bs-target="#editPersonalInfoModal">
                Edit Profile
              </button>
            </div>

            <!-- Profile Sections -->
            <div class="p-4">
              <div class="row g-4">
                
                <!-- Personal Information -->
                <div class="col-md-6">
                  <div class="bg-light rounded-3 p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="fw-bold mb-0"><i class="bi bi-person me-2"></i>Personal Information</h6>
                      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#editPersonalInfoModal">
                        <i class="bi bi-pencil me-1"></i>Edit
                      </button>
                    </div>
                    
                    <div class="mb-3">
                      <label class="form-label text-muted small">Full Name</label>
                      <p class="mb-0 fw-semibold">
                        {% if user.get_full_name %}
                          {{ user.get_full_name }}
                        {% else %}
                          {{ user.username }}
                        {% endif %}
                      </p>
                    </div>
                    
                    <div class="mb-3">
                      <label class="form-label text-muted small">Email Address</label>
                      <p class="mb-0">{{ user.email|default:"jane.doe@example.com" }}</p>
                    </div>
                    
                    <div class="mb-3">
                      <label class="form-label text-muted small">Phone Number</label>
                      <p class="mb-0">{{ user.phone_number|default:"Non renseigné" }}</p>
                    </div>
                    
                    <div class="mb-0">
                      <label class="form-label text-muted small">Date of Birth</label>
                      <p class="mb-0">{{ user.birth_date|date:"F d, Y"|default:"Non renseigné" }}</p>
                    </div>
                  </div>
                </div>

                <!-- Address Book -->
                <div class="col-md-6">
                  <div class="bg-light rounded-3 p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="fw-bold mb-0"><i class="bi bi-house me-2"></i>Address Book</h6>
                    </div>
                    
                    {% if user.addresses.all %}
                      {% for address in user.addresses.all %}
                        <div class="mb-3 border-bottom pb-2">
                          <div class="d-flex justify-content-between align-items-start">
                            <div>
                              <label class="form-label text-muted small">
                                {{ address.get_address_type_display }}
                                {% if address.is_default %}
                                  <span class="badge bg-primary ms-1">Par défaut</span>
                                {% endif %}
                              </label>
                              <p class="mb-0">{{ address.full_address }}</p>
                            </div>
                            <div class="dropdown">
                              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                              </button>
                              <ul class="dropdown-menu">
                                {% if not address.is_default %}
                                <li>
                                  <form method="POST" action="{% url 'manage_addresses' %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="set_default">
                                    <input type="hidden" name="address_id" value="{{ address.id }}">
                                    <button type="submit" class="dropdown-item">
                                      <i class="bi bi-star me-2"></i>Définir par défaut
                                    </button>
                                  </form>
                                </li>
                                {% endif %}
                                <li>
                                  <form method="POST" action="{% url 'manage_addresses' %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="address_id" value="{{ address.id }}">
                                    <button type="submit" class="dropdown-item text-danger" 
                                            onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette adresse ?')">
                                      <i class="bi bi-trash me-2"></i>Supprimer
                                    </button>
                                  </form>
                                </li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="text-center py-3">
                        <i class="bi bi-house-add text-muted fs-1"></i>
                        <p class="text-muted mt-2">Aucune adresse enregistrée</p>
                      </div>
                    {% endif %}
                    
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                      <i class="fas fa-plus me-2"></i>Add New Address
                    </button>
                  </div>
                </div>

                <!-- Payment Methods -->
                <div class="col-md-6">
                  <div class="bg-light rounded-3 p-4 h-100">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0"><i class="bi bi-credit-card me-2"></i>Payment Methods</h6>
                  </div>
                  
                  {% if user.payment_methods.all %}
                    {% for payment in user.payment_methods.all %}
                    <div class="d-flex align-items-center gap-2 mb-2">
                      {% if payment.card_type == "visa" %}
                      <i class="bi bi-credit-card-fill text-primary"></i>
                      {% elif payment.card_type == "mastercard" %}
                      <i class="bi bi-credit-card-fill text-warning"></i>
                      {% elif payment.card_type == "amex" %}
                      <i class="bi bi-credit-card-fill text-info"></i>
                      {% else %}
                      <i class="bi bi-credit-card-fill text-secondary"></i>
                      {% endif %}
                      <span>{{ payment.card_type|title }} ending in {{ payment.last4 }}</span>
                      {% if payment.is_default %}
                      <span class="badge bg-primary ms-1">Default</span>
                      {% endif %}
                      <div class="dropdown ms-auto">
                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                      </button>
                      <ul class="dropdown-menu">
                        {% if not payment.is_default %}
                        <li>
                        <form method="POST" action="{% url 'manage_payment_methods' %}" class="d-inline">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="set_default">
                          <input type="hidden" name="payment_id" value="{{ payment.id }}">
                          <button type="submit" class="dropdown-item">
                          <i class="bi bi-star me-2"></i>Set as Default
                          </button>
                        </form>
                        </li>
                        {% endif %}
                        <li>
                        <form method="POST" action="{% url 'manage_payment_methods' %}" class="d-inline">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="delete">
                          <input type="hidden" name="payment_id" value="{{ payment.id }}">
                          <button type="submit" class="dropdown-item text-danger" 
                              onclick="return confirm('Are you sure you want to delete this payment method?')">
                          <i class="bi bi-trash me-2"></i>Delete
                          </button>
                        </form>
                        </li>
                      </ul>
                      </div>
                    </div>
                    {% endfor %}
                  {% else %}
                    <div class="text-center py-3">
                    <i class="bi bi-credit-card text-muted fs-1"></i>
                    <p class="text-muted mt-2">No payment methods saved</p>
                    </div>
                  {% endif %}
                  
                  <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                    <i class="fas fa-plus me-2"></i>Add New Payment Method
                  </button>
                  </div>
                </div>

                <!-- Notification Preferences -->
                <div class="col-md-6">
                  <div class="bg-light rounded-3 p-4 h-100">
                    <h6 class="fw-bold mb-3"><i class="bi bi-bell me-2"></i>Notification Preferences</h6>
                    
                    <form method="POST" action="{% url 'update_notifications' %}">
                      {% csrf_token %}
                      
                      <div class="mb-3">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="email_notifications" name="email_notifications" 
                                 {% if user.email_notifications %}checked{% endif %}>
                          <label class="form-check-label" for="email_notifications">Email Notifications</label>
                        </div>
                      </div>
                      
                      <div class="mb-3">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="sms_notifications" name="sms_notifications" 
                                 {% if user.sms_notifications %}checked{% endif %}>
                          <label class="form-check-label" for="sms_notifications">SMS Notifications</label>
                        </div>
                      </div>
                      
                      <div class="mb-3">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="push_notifications" name="push_notifications" 
                                 {% if user.push_notifications %}checked{% endif %}>
                          <label class="form-check-label" for="push_notifications">Push Notifications</label>
                        </div>
                      </div>
                      
                      <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-save me-2"></i>Save Preferences
                      </button>
                    </form>
                  </div>
                </div>

                <!-- Security Settings -->
                <div class="col-md-6">
                  <div class="bg-primary bg-opacity-10 border border-primary rounded-3 p-4 h-100">
                    <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-shield-check me-2"></i>Security Settings</h6>
                    
                    <div class="mb-3">
                      <a href="{% url 'change_password' %}" class="btn btn-outline-primary btn-sm w-100 mb-2">
                        <i class="bi bi-key me-2"></i>Change Password
                      </a>
                      <button type="button" class="btn btn-outline-primary btn-sm w-100" 
                              data-bs-toggle="modal" data-bs-target="#twoFactorModal">
                        <i class="bi bi-shield-lock me-2"></i>Setup Two-Factor Authentication
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Data & Privacy -->
                <div class="col-md-6">
                  <div class="bg-light rounded-3 p-4 h-100">
                    <h6 class="fw-bold mb-3"><i class="bi bi-shield-lock me-2"></i>Data & Privacy</h6>
                    
                    <div class="mb-3">
                      <a href="{% url 'export_user_data' %}" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                        <i class="fas fa-download me-2"></i>Export My Data
                      </a>
                      <button type="button" class="btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                        <i class="fas fa-trash me-2"></i>Delete My Account
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Connected Accounts -->
                <div class="col-12">
                  <div class="bg-light rounded-3 p-4">
                    <h6 class="fw-bold mb-3"><i class="bi bi-link-45deg me-2"></i>Connected Accounts</h6>
                    
                    <div class="row g-3">
                      <div class="col-md-4">
                        <div class="d-flex align-items-center gap-3">
                          <i class="bi bi-twitter text-info fs-4"></i>
                          <div>
                            <p class="mb-0 fw-semibold">Twitter</p>
                            <small class="text-muted">@connection</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="d-flex align-items-center gap-3">
                          <i class="bi bi-facebook text-primary fs-4"></i>
                          <div>
                            <p class="mb-0 fw-semibold">Facebook</p>
                            <small class="text-muted">Jane Doe</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="d-flex align-items-center gap-3">
                          <i class="bi bi-linkedin text-primary fs-4"></i>
                          <div>
                            <p class="mb-0 fw-semibold">LinkedIn</p>
                            <small class="text-muted">Jane Doe</small>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <button class="btn btn-outline-primary btn-sm mt-3">Add New Account</button>
                  </div>
                </div>

              </div>
            </div>

            <!-- Edit Form (Collapsible) -->
            <div class="collapse" id="editProfileForm">
              <div class="border-top p-4">
                <h5 class="fw-bold mb-3">Edit Profile Information</h5>
                
                <form method="POST">
                  {% csrf_token %}
                  
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="first_name" class="form-label">First Name</label>
                      <input type="text" class="form-control" id="first_name" name="first_name" 
                             value="{{ user.first_name|default:'' }}" placeholder="Enter your first name">
                    </div>
                    
                    <div class="col-md-6">
                      <label for="last_name" class="form-label">Last Name</label>
                      <input type="text" class="form-control" id="last_name" name="last_name" 
                             value="{{ user.last_name|default:'' }}" placeholder="Enter your last name">
                    </div>
                    
                    <div class="col-12">
                      <label for="email" class="form-label">Email Address</label>
                      <input type="email" class="form-control" id="email" name="email" 
                             value="{{ user.email|default:'' }}" placeholder="Enter your email">
                    </div>
                    
                    <div class="col-md-6">
                      <label for="phone_number" class="form-label">Phone Number</label>
                      <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                             value="{{ user.phone_number|default:'' }}" placeholder="Enter your phone number">
                    </div>
                    
                    <div class="col-md-6">
                      <label for="date_of_birth" class="form-label">Date of Birth</label>
                      <input type="date" class="form-control" id="date_of_birth" name="date_of_birth">
                    </div>
                    
                    <div class="col-12">
                      <label for="address" class="form-label">Address</label>
                      <textarea class="form-control" id="address" name="address" rows="3" 
                                placeholder="Enter your address">{{ user.address|default:'' }}</textarea>
                    </div>
                    
                    <div class="col-12">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="newsletter" name="newsletter" 
                               {% if user.newsletter_subscription %}checked{% endif %}>
                        <label class="form-check-label" for="newsletter">
                          Subscribe to newsletter
                        </label>
                      </div>
                    </div>
                    
                    <div class="col-12">
                      <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Update Profile</button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#editProfileForm">
                          Cancel
                        </button>
                        <a href="{% url 'change_password' %}" class="btn btn-outline-warning">Change Password</a>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Modal: Delete Account Confirmation -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger" id="deleteAccountModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Delete Account
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <h6 class="alert-heading">⚠️ Warning!</h6>
          <p class="mb-0">This action is irreversible. All your data, orders, and account information will be permanently deleted.</p>
        </div>
        <form method="POST" action="{% url 'delete_user_account' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="delete_password" class="form-label">Confirm your password to proceed:</label>
            <input type="password" class="form-control" id="delete_password" name="password" required 
                   placeholder="Enter your current password">
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmDelete" required>
            <label class="form-check-label" for="confirmDelete">
              I understand that this action cannot be undone
            </label>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger flex-fill">Delete My Account</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Add Address -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAddressModalLabel">
          <i class="fas fa-plus me-2"></i>Add New Address
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{% url 'manage_addresses' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="add">
          
          <div class="mb-3">
            <label for="address_type" class="form-label">Address Type</label>
            <select class="form-select" id="address_type" name="address_type">
              <option value="home">Home</option>
              <option value="work">Work</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="street" class="form-label">Street Address *</label>
            <input type="text" class="form-control" id="street" name="street" required 
                   placeholder="123 Main Street">
          </div>
          
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="city" class="form-label">City *</label>
              <input type="text" class="form-control" id="city" name="city" required 
                     placeholder="Paris">
            </div>
            <div class="col-md-6">
              <label for="state" class="form-label">State/Province</label>
              <input type="text" class="form-control" id="state" name="state" 
                     placeholder="Île-de-France">
            </div>
          </div>
          
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="postal_code" class="form-label">Postal Code *</label>
              <input type="text" class="form-control" id="postal_code" name="postal_code" required 
                     placeholder="75001">
            </div>
            <div class="col-md-6">
              <label for="country" class="form-label">Country</label>
              <input type="text" class="form-control" id="country" name="country" value="France">
            </div>
          </div>
          
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary flex-fill">Add Address</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Add Payment Method -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPaymentModalLabel">
          <i class="fas fa-credit-card me-2"></i>Add Payment Method
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <small><i class="fas fa-info-circle me-1"></i>This is a demo. Real payment information should never be stored this way.</small>
        </div>
        <form method="POST" action="{% url 'manage_payment_methods' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="add">
          
          <div class="mb-3">
            <label for="card_number" class="form-label">Card Number *</label>
            <input type="text" class="form-control" id="card_number" name="card_number" required 
                   placeholder="1234 5678 9012 3456" maxlength="23">
            <small class="form-text text-muted">13-19 chiffres acceptés (Visa, Mastercard, Amex, etc.)</small>
          </div>
          
          <div class="mb-3">
            <label for="card_name" class="form-label">Cardholder Name *</label>
            <input type="text" class="form-control" id="card_name" name="card_name" required 
                   placeholder="John Doe">
          </div>
          
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="expiry_date" class="form-label">Expiry Date *</label>
              <input type="text" class="form-control" id="expiry_date" name="expiry_date" required 
                     placeholder="MM/YY" maxlength="5">
              <small class="form-text text-muted">Format: MM/YY</small>
            </div>
            <div class="col-md-6">
              <label for="cvv" class="form-label">CVV *</label>
              <input type="text" class="form-control" id="cvv" name="cvv" required 
                     placeholder="123" maxlength="4">
              <small class="form-text text-muted">3-4 chiffres au dos</small>
            </div>
          </div>
          
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary flex-fill">Add Payment Method</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Edit Personal Information -->
<div class="modal fade" id="editPersonalInfoModal" tabindex="-1" aria-labelledby="editPersonalInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPersonalInfoModalLabel">
          <i class="bi bi-person-gear me-2"></i>Edit Personal Information
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" id="editPersonalInfoForm">
          {% csrf_token %}
          
          <div class="row g-3">
            <div class="col-md-6">
              <label for="modal_first_name" class="form-label">First Name</label>
              <input type="text" class="form-control" id="modal_first_name" name="first_name" 
                     value="{{ user.first_name|default:'' }}" placeholder="Enter your first name">
            </div>
            
            <div class="col-md-6">
              <label for="modal_last_name" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="modal_last_name" name="last_name" 
                     value="{{ user.last_name|default:'' }}" placeholder="Enter your last name">
            </div>
            
            <div class="col-12">
              <label for="modal_email" class="form-label">Email Address</label>
              <input type="email" class="form-control" id="modal_email" name="email" 
                     value="{{ user.email|default:'' }}" placeholder="Enter your email">
            </div>
            
            <div class="col-md-6">
              <label for="modal_phone_number" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="modal_phone_number" name="phone_number" 
                     value="{{ user.phone_number|default:'' }}" placeholder="Enter your phone number">
            </div>
            
            <div class="col-md-6">
              <label for="modal_date_of_birth" class="form-label">Date of Birth</label>
              <input type="date" class="form-control" id="modal_date_of_birth" name="date_of_birth" 
                     value="{{ user.birth_date|date:'Y-m-d'|default:'' }}">
            </div>
            
            <div class="col-12">
              <label for="modal_address" class="form-label">Address</label>
              <textarea class="form-control" id="modal_address" name="address" rows="3" 
                        placeholder="Enter your address">{{ user.address|default:'' }}</textarea>
            </div>
            
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="modal_newsletter" name="newsletter" 
                       {% if user.newsletter_subscription %}checked{% endif %}>
                <label class="form-check-label" for="modal_newsletter">
                  Subscribe to newsletter
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i>Cancel
        </button>
        <button type="submit" form="editPersonalInfoForm" class="btn btn-primary">
          <i class="bi bi-check-circle me-2"></i>Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Two-Factor Authentication -->
<div class="modal fade" id="twoFactorModal" tabindex="-1" aria-labelledby="twoFactorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="twoFactorModalLabel">
          <i class="bi bi-shield-lock me-2"></i>Two-Factor Authentication
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if user.two_factor_enabled %}
          <div class="alert alert-success">
            <h6 class="alert-heading"><i class="bi bi-shield-check me-2"></i>Two-Factor Authentication Active</h6>
            <p class="mb-0">Your account is protected with two-factor authentication.</p>
          </div>
          
          <form method="POST" action="{% url 'setup_two_factor' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="disable">
            
            <div class="mb-3">
              <label for="current_password_2fa" class="form-label">Current Password *</label>
              <input type="password" class="form-control" id="current_password_2fa" name="current_password" required 
                     placeholder="Enter your current password">
            </div>
            
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger flex-fill">
                <i class="bi bi-shield-x me-2"></i>Disable 2FA
              </button>
            </div>
          </form>
        {% else %}
          <div class="alert alert-info">
            <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Secure Your Account</h6>
            <p class="mb-0">Two-factor authentication adds an extra layer of security to your account using a TOTP app like Google Authenticator or Authy.</p>
          </div>
          
          <form method="POST" action="{% url 'setup_two_factor' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="enable">
            
            <div class="mb-3">
              <label for="current_password_2fa_enable" class="form-label">Current Password *</label>
              <input type="password" class="form-control" id="current_password_2fa_enable" name="current_password" required 
                     placeholder="Enter your current password">
            </div>
            
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="backup_codes" name="backup_codes" required>
              <label class="form-check-label" for="backup_codes">
                I have a TOTP app installed (Google Authenticator, Authy, etc.)
              </label>
            </div>
            
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary flex-fill">
                <i class="bi bi-shield-check me-2"></i>Enable 2FA
              </button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal: Two-Factor QR Code -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrCodeModalLabel">
          <i class="bi bi-qr-code me-2"></i>Setup Authenticator App
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="alert alert-info">
          <h6 class="alert-heading">Scan this QR Code</h6>
          <p class="mb-0">Open your authenticator app and scan the QR code below to add your account.</p>
        </div>
        
        <div class="mb-3" id="qr-code-container">
          <!-- QR Code will be loaded here -->
        </div>
        
        <div class="alert alert-warning">
          <small>
            <strong>Important:</strong> Save this QR code or write down the secret key in a safe place.
            You'll need it to access your account if you lose your phone.
          </small>
        </div>
        
        <!-- Verification form for 2FA setup -->
        <div id="verification-form" style="display: none;">
          <div class="alert alert-success">
            <h6 class="alert-heading">Verify Your Setup</h6>
            <p class="mb-0">Enter the 6-digit code from your authenticator app to complete setup:</p>
          </div>
          
          <form method="POST" action="{% url 'setup_two_factor' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="enable">
            <input type="hidden" name="current_password" id="stored-password">
            
            <div class="mb-3">
              <input type="text" class="form-control text-center" name="verification_code" 
                     maxlength="6" pattern="[0-9]{6}" placeholder="000000" required
                     style="font-size: 18px; letter-spacing: 3px;">
            </div>
            
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success flex-fill">
                <i class="bi bi-check-circle me-2"></i>Verify & Enable 2FA
              </button>
            </div>
          </form>
        </div>
        
        <div id="initial-button">
          <button type="button" class="btn btn-primary" onclick="showVerificationForm()">
            <i class="bi bi-check-circle me-2"></i>I've Added the Account
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Profile Page Styles */
.form-check-input:checked {
  background-color: var(--bs-primary);
  border-color: var(--bs-primary);
}

.form-switch .form-check-input {
  width: 2.5em;
  height: 1.25em;
}

.bg-opacity-10 {
  background-color: rgba(var(--bs-primary-rgb), 0.1) !important;
}

.rounded-circle {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.badge {
  border-radius: 20px;
  font-weight: 500;
}

.form-control {
  border-radius: 8px;
  border: 1px solid #e9ecef;
  padding: 0.75rem 1rem;
  transition: all 0.2s ease;
}

.form-control:focus {
  border-color: var(--bs-primary);
  box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

.btn {
  border-radius: 8px;
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-1px);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .d-flex.gap-3 {
    flex-wrap: wrap;
  }
  
  .badge {
    font-size: 0.875rem;
  }
}

/* Modal improvements */
.modal-lg {
  max-width: 600px;
}

.modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.modal-header .btn-close {
  filter: invert(1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si on doit afficher la modal QR
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('show_qr') === '1') {
        const isVerification = urlParams.get('verify') === '1';
        const qrUrl = isVerification ? 
            '{% url "two_factor_qr" %}?verify=1' : 
            '{% url "two_factor_qr" %}';
        
        // Charger le QR code et afficher la modal
        fetch(qrUrl)
            .then(response => response.text())
            .then(data => {
                document.getElementById('qr-code-container').innerHTML = data;
                const qrModal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
                qrModal.show();
                
                // Si c'est une vérification, montrer le formulaire de vérification
                if (isVerification) {
                    document.getElementById('initial-button').style.display = 'none';
                    document.getElementById('verification-form').style.display = 'block';
                }
                
                // Nettoyer l'URL sans recharger la page
                window.history.replaceState({}, document.title, window.location.pathname);
            })
            .catch(error => {
                console.error('Erreur lors du chargement du QR code:', error);
            });
    }
});

function showVerificationForm() {
    document.getElementById('initial-button').style.display = 'none';
    document.getElementById('verification-form').style.display = 'block';
    
    // Récupérer le mot de passe depuis le formulaire 2FA
    const passwordField = document.getElementById('current_password_2fa_enable');
    if (passwordField) {
        document.getElementById('stored-password').value = passwordField.value;
    }
}
</script>

{% endblock %}
