{% extends 'base.html' %}
{% load static %}

{% block title %}Paiement - YEE E-Commerce{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
    <!-- En-t√™te Rhode Style -->
    <div class="text-center mb-5">
        <h1 style="font-size: 2.5rem; font-weight: 600; color: var(--rhode-black, #000); text-transform: lowercase; letter-spacing: -0.02em; margin-bottom: 0.5rem;">
            finaliser votre paiement
        </h1>
        <p style="color: var(--rhode-gray-medium, #666); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
            paiement s√©curis√© ‚Ä¢ {{ total }} ‚Ç¨
        </p>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- R√©capitulatif de la commande Rhode Style -->
            <div class="payment-section-rhode mb-5" style="background: var(--rhode-white, #fff); border: 1px solid var(--rhode-gray-light, #e5e5e5); border-radius: 0; padding: 2rem;">
                <h3 style="font-size: 1.2rem; font-weight: 500; color: var(--rhode-black, #000); text-transform: lowercase; letter-spacing: -0.01em; margin-bottom: 1.5rem; border-bottom: 1px solid var(--rhode-gray-light, #e5e5e5); padding-bottom: 0.75rem;">
                    r√©capitulatif de commande
                </h3>

                {% for item in order_items %}
                    <div class="payment-item-rhode d-flex align-items-center py-3" style="border-bottom: 1px solid var(--rhode-gray-light, #e5e5e5);">
                        <div class="flex-grow-1">
                            <h6 style="font-size: 0.95rem; font-weight: 500; color: var(--rhode-black, #000); text-transform: lowercase; letter-spacing: -0.01em; margin-bottom: 0.25rem;">
                                {{ item.product.name }}
                            </h6>
                            <small style="color: var(--rhode-gray-medium, #666); font-size: 0.8rem;">
                                {{ item.unit_price }} ‚Ç¨ √ó {{ item.quantity }}
                            </small>
                        </div>
                        <div class="text-end">
                            <span style="font-weight: 600; color: var(--rhode-black, #000); font-size: 1rem;">
                                {{ item.item_total }} ‚Ç¨
                            </span>
                        </div>
                    </div>
                {% endfor %}

                <div class="d-flex justify-content-between align-items-center pt-3">
                    <span style="color: var(--rhode-black, #000); font-weight: 600; font-size: 1.1rem; text-transform: lowercase;">
                        total √† payer
                    </span>
                    <span style="color: var(--rhode-black, #000); font-weight: 600; font-size: 1.3rem;">
                        {{ total }} ‚Ç¨
                    </span>
                </div>
            </div>
            
            <!-- Modes de paiement Rhode Style -->
            <div class="payment-section-rhode" style="background: var(--rhode-white, #fff); border: 1px solid var(--rhode-gray-light, #e5e5e5); border-radius: 0; padding: 2rem;">
                <h3 style="font-size: 1.2rem; font-weight: 500; color: var(--rhode-black, #000); text-transform: lowercase; letter-spacing: -0.01em; margin-bottom: 1.5rem; border-bottom: 1px solid var(--rhode-gray-light, #e5e5e5); padding-bottom: 0.75rem;">
                    m√©thode de paiement
                </h3>

                <!-- Navigation des onglets Rhode Style -->
                <div class="payment-tabs-rhode mb-4">
                    <button class="payment-tab-rhode active" id="stripe-tab" data-tab="stripe"
                            style="background: transparent; border: 1px solid var(--rhode-black, #000); color: var(--rhode-black, #000); padding: 0.875rem 1.5rem; font-weight: 500; text-transform: lowercase; letter-spacing: 0.3px; border-radius: 0; margin-right: 1rem; transition: all 0.2s ease;">
                        Stripe
                    </button>
                    <button class="payment-tab-rhode" id="paypal-tab" data-tab="paypal"
                            style="background: transparent; border: 1px solid var(--rhode-gray-medium, #666); color: var(--rhode-gray-medium, #666); padding: 0.875rem 1.5rem; font-weight: 500; text-transform: lowercase; letter-spacing: 0.3px; border-radius: 0; transition: all 0.2s ease;">
                        paypal
                    </button>
                </div>

                <!-- Contenu des onglets -->
                <div class="payment-content-rhode">
                    <!-- Paiement par carte Stripe -->
                    <div class="payment-pane active" id="stripe-pane">
                        <form id="stripe-payment-form" method="POST" action="{% url 'accounts:stripe_confirm_payment' %}">
                            {% csrf_token %}
                            <input type="hidden" name="amount" value="{{ total }}">

                            <div class="mb-4">
                                <label style="color: var(--rhode-black, #000); font-size: 0.85rem; font-weight: 500; text-transform: lowercase; letter-spacing: 0.3px; margin-bottom: 0.75rem; display: block;">
                                    informations de la carte *
                                </label>
                                <div id="card-element" class="payment-card-element"
                                     style="border: 1px solid var(--rhode-gray-medium, #666); border-radius: 0; padding: 1rem; background: var(--rhode-white, #fff); min-height: 50px; transition: border-color 0.2s ease;">
                                    <!-- Stripe Elements ins√©rera le formulaire ici -->
                                </div>
                                <div id="card-errors" style="color: #dc3545; font-size: 0.8rem; margin-top: 0.5rem;" role="alert"></div>
                            </div>

                            <button id="stripe-submit" type="submit"
                                    style="width: 100%; background: var(--rhode-black, #000); color: white; border: none; padding: 1rem 1.5rem; font-weight: 500; text-transform: lowercase; letter-spacing: 0.3px; border-radius: 0; font-size: 0.95rem; transition: all 0.2s ease;"
                                    onmouseover="this.style.background='#333';"
                                    onmouseout="this.style.background='var(--rhode-black, #000)';">
                                <span id="stripe-button-text">
                                    payer {{ total }} ‚Ç¨ par carte
                                </span>
                                <div id="stripe-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                                    <span class="visually-hidden">traitement...</span>
                                </div>
                            </button>

                            <p style="color: var(--rhode-gray-medium, #666); font-size: 0.75rem; text-align: center; margin-top: 1rem; line-height: 1.4;">
                                üîí paiement s√©curis√© par stripe ‚Ä¢ vos donn√©es sont prot√©g√©es
                            </p>
                        </form>
                    </div>

                    <!-- Paiement PayPal -->
                    <div class="payment-pane" id="paypal-pane" style="display: none;">
                        <div class="text-center py-4">
                            <p style="color: var(--rhode-gray-medium, #666); font-size: 0.9rem; margin-bottom: 2rem;">
                                payez en toute s√©curit√© avec votre compte paypal
                            </p>

                            <form method="POST" action="{% url 'accounts:process_paypal_payment' %}">
                                {% csrf_token %}
                                <button type="submit"
                                        style="background: #0070ba; color: white; border: none; padding: 1rem 2rem; font-weight: 500; text-transform: lowercase; letter-spacing: 0.3px; border-radius: 0; font-size: 0.95rem; transition: all 0.2s ease;"
                                        onmouseover="this.style.background='#005ea6';"
                                        onmouseout="this.style.background='#0070ba';">
                                    payer avec paypal ({{ total }} ‚Ç¨)
                                </button>
                            </form>

                            <p style="color: var(--rhode-gray-medium, #666); font-size: 0.75rem; margin-top: 1rem;">
                                vous serez redirig√© vers paypal pour finaliser le paiement
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar s√©curit√© Rhode Style -->
        <div class="col-lg-4">
            <div class="payment-sidebar-rhode mb-4" style="background: var(--rhode-cream, #f8f8f8); padding: 2rem; border-radius: 0;">
                <h4 style="font-size: 1.1rem; font-weight: 600; color: var(--rhode-black, #000); text-transform: lowercase; letter-spacing: -0.01em; margin-bottom: 1.5rem;">
                    paiement s√©curis√©
                </h4>

                <div class="security-features">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-lock-fill me-3" style="color: var(--rhode-black, #000); font-size: 1.1rem;"></i>
                        <span style="color: var(--rhode-gray-medium, #666); font-size: 0.85rem;">chiffrement ssl 256 bits</span>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-shield-fill-check me-3" style="color: var(--rhode-black, #000); font-size: 1.1rem;"></i>
                        <span style="color: var(--rhode-gray-medium, #666); font-size: 0.85rem;">conformit√© pci dss</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-eye-slash-fill me-3" style="color: var(--rhode-black, #000); font-size: 1.1rem;"></i>
                        <span style="color: var(--rhode-gray-medium, #666); font-size: 0.85rem;">aucune donn√©e stock√©e</span>
                    </div>
                </div>
            </div>
            
            <div class="payment-sidebar-rhode" style="background: var(--rhode-white, #fff); border: 1px solid var(--rhode-gray-light, #e5e5e5); padding: 2rem; border-radius: 0;">
                <h4 style="font-size: 1.1rem; font-weight: 600; color: var(--rhode-black, #000); text-transform: lowercase; letter-spacing: -0.01em; margin-bottom: 1.5rem;">
                    besoin d'aide ?
                </h4>

                <p style="color: var(--rhode-gray-medium, #666); font-size: 0.85rem; margin-bottom: 1.5rem;">
                    probl√®me avec votre paiement ?
                </p>

                <div class="d-grid gap-3">
                    <a href="#"
                       style="background: transparent; color: var(--rhode-gray-medium, #666); border: 1px solid var(--rhode-gray-medium, #666); padding: 0.75rem 1rem; font-weight: 500; text-decoration: none; text-transform: lowercase; letter-spacing: 0.3px; text-align: center; transition: all 0.2s ease; border-radius: 0; display: block;"
                       onmouseover="this.style.background='var(--rhode-gray-medium, #666)'; this.style.color='white';"
                       onmouseout="this.style.background='transparent'; this.style.color='var(--rhode-gray-medium, #666)';">
                        contacter le support
                    </a>

                    <a href="{% url 'store:cart' %}"
                       style="background: transparent; color: var(--rhode-black, #000); border: none; padding: 0.5rem; font-size: 0.85rem; text-decoration: underline; text-transform: lowercase; letter-spacing: 0.3px; text-align: center; transition: color 0.2s ease;"
                       onmouseover="this.style.color='var(--rhode-gray-medium, #666)';"
                       onmouseout="this.style.color='var(--rhode-black, #000)';">
                        retour au panier
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS et JavaScript pour les onglets Rhode Style -->
<style>
.payment-section-rhode:hover {
    border-color: var(--rhode-gray-medium, #666) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.payment-item-rhode:last-child {
    border-bottom: none !important;
}

.payment-tab-rhode.active {
    background: var(--rhode-black, #000) !important;
    color: white !important;
    border-color: var(--rhode-black, #000) !important;
}

.payment-tab-rhode:hover {
    background: var(--rhode-black, #000);
    color: white;
    border-color: var(--rhode-black, #000);
}

.payment-card-element:focus-within {
    border-color: var(--rhode-black, #000) !important;
    box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .payment-sidebar-rhode {
        margin-top: 2rem;
    }

    .payment-section-rhode {
        padding: 1.5rem !important;
    }

    .payment-tab-rhode {
        display: block !important;
        width: 100% !important;
        margin: 0 0 0.5rem 0 !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des onglets de paiement
    const tabs = document.querySelectorAll('.payment-tab-rhode');
    const panes = document.querySelectorAll('.payment-pane');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;

            // Retirer la classe active de tous les onglets
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.background = 'transparent';
                t.style.color = 'var(--rhode-gray-medium, #666)';
                t.style.borderColor = 'var(--rhode-gray-medium, #666)';
            });

            // Ajouter la classe active √† l'onglet cliqu√©
            this.classList.add('active');
            this.style.background = 'var(--rhode-black, #000)';
            this.style.color = 'white';
            this.style.borderColor = 'var(--rhode-black, #000)';

            // Masquer tous les panneaux
            panes.forEach(pane => {
                pane.style.display = 'none';
                pane.classList.remove('active');
            });

            // Afficher le panneau correspondant
            const targetPane = document.getElementById(targetTab + '-pane');
            if (targetPane) {
                targetPane.style.display = 'block';
                targetPane.classList.add('active');
            }
        });
    });
});
</script>

<!-- Stripe Elements JavaScript (si n√©cessaire) -->
{% if stripe_public_key %}
<script src="https://js.stripe.com/v3/"></script>
<script>
// Configuration Stripe avec le style Rhode
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements({
    appearance: {
        theme: 'flat',
        variables: {
            colorPrimary: '#000000',
            colorBackground: '#ffffff',
            colorText: '#000000',
            colorDanger: '#dc3545',
            fontFamily: 'Inter, system-ui, sans-serif',
            spacingUnit: '4px',
            borderRadius: '0px',
        }
    }
});

const cardElement = elements.create('card');
cardElement.mount('#card-element');

// Gestion des erreurs
cardElement.on('change', function(event) {
    const displayError = document.getElementById('card-errors');
    if (event.error) {
        displayError.textContent = event.error.message;
    } else {
        displayError.textContent = '';
    }
});

// Soumission du formulaire
const form = document.getElementById('stripe-payment-form');
form.addEventListener('submit', async function(event) {
    event.preventDefault();

    const submitButton = document.getElementById('stripe-submit');
    const buttonText = document.getElementById('stripe-button-text');
    const spinner = document.getElementById('stripe-spinner');
    
    submitButton.disabled = true;
    buttonText.style.display = 'none';
    spinner.classList.remove('d-none');

    const {token, error} = await stripe.createToken(cardElement);

    if (error) {
        document.getElementById('card-errors').textContent = error.message;
        submitButton.disabled = false;
        buttonText.style.display = 'inline';
        spinner.classList.add('d-none');
    } else {
        // Ajouter le token au formulaire et le soumettre
        const hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'stripeToken');
        hiddenInput.setAttribute('value', token.id);
        form.appendChild(hiddenInput);
        form.submit();
    }
});
</script>
{% endif %}
{% endblock %}